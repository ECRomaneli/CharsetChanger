"use strict";var Charset,__awaiter=this&&this.__awaiter||function(t,e,r,s){return new(r||(r=Promise))(function(i,n){function o(t){try{a(s.next(t))}catch(t){n(t)}}function h(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(o,h)}a((s=s.apply(t,e||[])).next())})};function charsetChanger(t){return charsetChanger.instance.setConfig(t).convert()}function charsetChangerSync(t){charsetChanger.instance.setConfig(t).convertSync()}Object.defineProperty(exports,"__esModule",{value:!0}),exports.charsetChanger=charsetChanger,exports.charsetChangerSync=charsetChangerSync,function(t){t.UCS2="ucs2",t.UTF7="UTF-7",t.UTF7_IMAP="UTF-7-IMAP",t.UTF16="UTF16",t.UTF32="UTF32",t.ASCII="ascii",t.BINARY="binary",t.BASE64="base64",t.HEX="hex",t.WIN1252="windows-1252",t.CP1252="windows-1252",t.LATIN1="ISO-8859-1",t.UTF8="UTF-8",t.UTF16_LE="UTF-16 LE",t.UTF16_BE="UTF-16 BE",t.UTF32_LE="UTF-32 LE",t.UTF32_BE="UTF-32 BE",t.ISO2022_JP="ISO-2022-JP",t.ISO2022_KR="ISO-2022-KR",t.ISO2022_CN="ISO-2022-CN",t.SHIFT_JIS="Shift-JIS",t.BIG5="Big5",t.EUC_JP="EUC-JP",t.EUC_KR="EUC-KR",t.GB18030="GB18030",t.ISO8859_1="ISO-8859-1",t.ISO8859_2="ISO-8859-2",t.ISO8859_5="ISO-8859-5",t.ISO8859_6="ISO-8859-6",t.ISO8859_7="ISO-8859-7",t.ISO8859_8="ISO-8859-8",t.ISO8859_9="ISO-8859-9",t.WINDOWS_1250="windows-1250",t.WINDOWS_1251="windows-1251",t.WINDOWS_1252="windows-1252",t.WINDOWS_1253="windows-1253",t.WINDOWS_1254="windows-1254",t.WINDOWS_1255="windows-1255",t.WINDOWS_1256="windows-1256",t.KOI8_R="KOI8-R"}(Charset=exports.Charset||(exports.Charset={})),function(t){const e=require("fs"),{glob:r}=require("glob"),s=require("chardet"),i=require("iconv-lite"),n=".bkp",o=()=>{},h=2e5;class a{constructor(){this._messageList=[]}tryConvert(t){try{t(),this._onFinish(!0,this._messageList)}catch(t){f("error",t,!0),this._onFinish(!1,this._messageList)}}addMessage(t,e,r){if(this._messageList.push({file:t,message:e}),r)throw e}rootPath(t){return this._root+t}detectCharset(t,e){let r=s.detect(e,{sampleSize:h});if(i.encodingExists(r))if(this._to===this._from)this.addMessage(t,c(t,`The file is already ${r}`));else{if(!_(this._detectorFilter(t,r)))return r;this.addMessage(t,c(t,`Charset: ${r}`))}else this.addMessage(t,d(r));return null}getDecodedData(t){let r=e.readFileSync(this.rootPath(t)),s=this._from||this.detectCharset(t,r);return s?i.decode(e.readFileSync(this.rootPath(t)),s):null}setEncodedData(t,r){e.writeFileSync(this.rootPath(t),i.encode(r,this._to))}createBackup(t){this._createBackup&&(t=this.rootPath(t),e.copyFileSync(t,t+this.backupSuffix))}listFiles(){try{let t=r.sync(this._search,{cwd:this._root,ignore:this._ignore,nodir:!0});return _(this._onList(t))&&this.addMessage(null,u("onList"),!0),t}catch(t){return f("error",t,!0),[]}}changeCharset(t,e,r){let s=this.getDecodedData(t);_(this._onBeforeConvert(t,s,e,r))?this.addMessage(t,u("onBeforeConvert")):(this.createBackup(t),this.setEncodedData(t,s),_(this._onAfterConvert(t,s,e,r))&&this.addMessage(t,u("onBeforeConvert"),!0))}startConvert(){let t=this.listFiles();this.tryConvert(()=>t.forEach((t,e,r)=>this.changeCharset(t,e,r)))}convert(){return __awaiter(this,void 0,void 0,function*(){this.startConvert()})}convertSync(){this.startConvert()}root(t){return void 0===t?this._root:(this._root="/"!==t.charAt(t.length-1)?t+"/":t,this)}search(t){return void 0===t?this._search:(this._search=t,this)}ignore(t){return void 0===t?this._ignore:(this._ignore=t,this)}from(t){if(void 0===t)return this._from;if(null!==t&&!i.encodingExists(t))throw d(t);return this._from=t,this}to(t){if(void 0===t)return this._to;if(!i.encodingExists(t))throw d(t);return this._to=t,this}backup(t,e){return void 0===t&&void 0===e?this.backupSuffix:"boolean"==typeof t?this.backup(void 0,t):(this._createBackup=void 0===e||e,this.backupSuffix=void 0!==t?t:n,this)}onList(t){return this._onList=t,this}onBeforeConvert(t){return this._onBeforeConvert=t,this}onAfterConvert(t){return this._onAfterConvert=t,this}onFinish(t){return this._onFinish=t,this}detectorFilter(t){return this._detectorFilter=t,this}setConfig(t){return this.root(t.root||null).search(t.search||"**/*").ignore(t.ignore||null).from(t.from||null).to(t.to||null).backup(t.backupSuffix,t.createBackup||!!t.backupSuffix).onList(t.onList||o).onBeforeConvert(t.onBeforeConvert||o).onAfterConvert(t.onAfterConvert||o).onFinish(t.onFinish||o).detectorFilter(t.detectorFilter||o)}}t.Class=a,t.instance=new a;const c=(t,e)=>`Skipping "${t}" conversion. ${e}.`,u=t=>`The ${t} listener returned false.`,d=t=>`Encoding ${t} is not supported!`;function _(t){return!1===t}function f(t,e,r){if("none"!==t){if(r&&"error"===t)throw`[CharsetChanger] ${e}`;console[t]("[CharsetChanger]",e)}}}(charsetChanger=exports.charsetChanger||(exports.charsetChanger={})),exports.Class=charsetChanger.Class,exports.CharsetChanger=exports.Class;