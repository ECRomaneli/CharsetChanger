"use strict";var Charset,__awaiter=this&&this.__awaiter||function(t,r,e,n){return new(e||(e=Promise))(function(o,i){function s(t){try{a(n.next(t))}catch(t){i(t)}}function h(t){try{a(n.throw(t))}catch(t){i(t)}}function a(t){var r;t.done?o(t.value):(r=t.value,r instanceof e?r:new e(function(t){t(r)})).then(s,h)}a((n=n.apply(t,r||[])).next())})};function charsetChanger(t){return charsetChanger.instance.setConfig(t).convert()}function charsetChangerSync(t){return charsetChanger.instance.setConfig(t).convertSync()}Object.defineProperty(exports,"__esModule",{value:!0}),exports.charsetChanger=charsetChanger,exports.charsetChangerSync=charsetChangerSync,function(t){t.UCS2="ucs2",t.UTF7="utf-7",t.UTF7_IMAP="utf-7-imap",t.UTF8="utf8",t.UTF16="utf16",t.UTF16_LE="utf16-le",t.UTF16_BE="utf16-le",t.UTF32="utf32",t.UTF32_LE="utf32-le",t.UTF32_BE="utf32-le",t.ASCII="ascii",t.BINARY="binary",t.BASE64="base64",t.HEX="hex",t.WIN1252="cp1252",t.CP1252="cp1252",t.ISO8859_1="iso8859-1",t.LATIN1="iso8859-1"}(Charset=exports.Charset||(exports.Charset={})),function(t){const r=require("fs"),{glob:e}=require("glob"),n=require("iconv-lite");class o{rootPath(t){return this._root+t}createBackup(t){this._createBackup&&(t=this.rootPath(t),r.copyFileSync(t,t+this.backupSuffix))}getDecodedData(t,e){return n.decode(r.readFileSync(this.rootPath(t)),e)}setEncodedData(t,e,o){r.writeFileSync(this.rootPath(t),n.encode(e,o))}listFiles(){try{let t=e.sync(this._search,{cwd:this._root,ignore:this._ignore,cache:"FILE"});if(s(this._onList(t)))throw i("onList");return t}catch(t){return h("error",t,!0),[]}}changeCharset(t,r,e){try{let n=this.getDecodedData(t,this._from);if(s(this._onBeforeConvert(t,n,r,e)))throw i("onBeforeConvert");if(this.createBackup(t),this.setEncodedData(t,n,this._to),s(this._onAfterConvert(t,n,r,e)))throw i("onAfterConvert")}catch(t){h("error",t,!0)}}startConvert(){let t=this.listFiles(),r=function(t,r){try{return t()||!0}catch(t){return h("error",t,r)&&!1}}(()=>t.forEach((t,r,e)=>this.changeCharset(t,r,e)));return this._onFinish(r),r}convert(){return __awaiter(this,void 0,void 0,function*(){return this.startConvert()})}convertSync(){return this.startConvert()}root(t){return void 0===t?this._root:(this._root="/"!==t.charAt(t.length-1)?t+"/":t,this)}search(t){return void 0===t?this._search:(this._search=t,this)}ignore(t){return void 0===t?this._ignore:(this._ignore=t,this)}from(t){if(void 0===t)return this._from;if(!n.encodingExists(t))throw`Encoding ${t} is not supported!`;return this._from=t,this}to(t){if(void 0===t)return this._to;if(!n.encodingExists(t))throw`Encoding ${t} is not supported!`;return this._to=t,this}backup(t,r){return void 0===t&&void 0===r?this.backupSuffix:"boolean"==typeof t?this.backup(void 0,t):(this._createBackup=void 0===r||r,this.backupSuffix=void 0!==t?t:o.DEFAULT_BACKUP_SUFFIX,this)}onList(t){return this._onList=t,this}onBeforeConvert(t){return this._onBeforeConvert=t,this}onAfterConvert(t){return this._onAfterConvert=t,this}onFinish(t){return this._onFinish=t,this}setConfig(t){return this.root(t.root||null).search(t.search||"**/*").ignore(t.ignore||null).from(t.from||null).to(t.to||null).backup(t.backupSuffix,t.createBackup||!!t.backupSuffix).onList(t.onList||o.DEFAULT_LISTENER).onBeforeConvert(t.onBeforeConvert||o.DEFAULT_LISTENER).onAfterConvert(t.onAfterConvert||o.DEFAULT_LISTENER).onFinish(t.onFinish||o.DEFAULT_LISTENER)}}function i(t){return`Aborted by ${t} listener.`}function s(t){return!1===t}function h(t,r,e){if("none"!==t){if(e&&"error"===t)throw`[CharsetChanger] ${r}`;console[t]("[CharsetChanger]",r)}}o.DEFAULT_BACKUP_SUFFIX=".bkp",o.DEFAULT_LISTENER=(()=>{}),t.Class=o,t.instance=new o}(charsetChanger=exports.charsetChanger||(exports.charsetChanger={})),exports.Class=charsetChanger.Class,exports.CharsetChanger=exports.Class;